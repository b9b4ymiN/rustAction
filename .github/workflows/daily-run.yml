name: KS Forward Daily Runner

on:
  schedule:
    # Run every day at 4:00 AM Bangkok time (UTC+7)
    # cron: 0 4 * * * in Bangkok = 0 21 * * * in UTC
    - cron: "0 21 * * *"
  workflow_dispatch:
    inputs:
      reason:
        description: 'Reason for manual run'
        required: false
        default: 'Manual trigger'

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  run:
    name: Process KS Forward Videos
    runs-on: ubuntu-latest
    timeout-minutes: 30

    env:
      TZ: Asia/Bangkok

    steps:
      - name: üì• Checkout repository
        uses: actions/checkout@v4

      - name: üîß Configure Rust environment
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable
          components: clippy, rustfmt

      - name: üíæ Cache cargo registry
        uses: actions/cache@v4
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-registry-

      - name: üíæ Cache cargo index
        uses: actions/cache@v4
        with:
          path: ~/.cargo/git
          key: ${{ runner.os }}-cargo-index-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-index-

      - name: üíæ Cache cargo build
        uses: actions/cache@v4
        with:
          path: target
          key: ${{ runner.os }}-cargo-build-target-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-build-target-

      - name: üîç Verify configuration
        run: |
          echo "Verifying required secrets..."
          required_secrets=("API_URL" "TOKEN" "YOUTUBE_API_KEY" "SUPABASE_API_KEY" "KSFORWORD_CHANNEL_ID" "MY_AI_API_URL" "DISCORD_KS_BOT_TOKEN")
          missing=0
          for secret in "${required_secrets[@]}"; do
            if [ -z "${{ secrets[secret] }}" ]; then
              echo "‚ùå Missing secret: $secret"
              missing=$((missing + 1))
            else
              echo "‚úÖ Found: $secret"
            fi
          done
          if [ $missing -gt 0 ]; then
            echo "‚ùå $missing required secrets are missing!"
            exit 1
          fi
          echo "‚úÖ All required secrets are configured"

      - name: üìù Create environment file
        run: |
          cat <<EOF > .env
          API_URL=${{ secrets.API_URL }}
          TOKEN=${{ secrets.TOKEN }}
          YOUTUBE_API_KEY=${{ secrets.YOUTUBE_API_KEY }}
          SUPABASE_API_KEY=${{ secrets.SUPABASE_API_KEY }}
          KSFORWORD_CHANNEL_ID=${{ secrets.KSFORWORD_CHANNEL_ID }}
          USE_MOCK_DATA=${{ secrets.USE_MOCK_DATA || 'false' }}
          MY_AI_API_URL=${{ secrets.MY_AI_API_URL }}
          DISCORD_KS_BOT_TOKEN=${{ secrets.DISCORD_KS_BOT_TOKEN }}
          EOF
          echo "‚úÖ Environment file created"

      - name: üéØ Run linter checks
        run: |
          cargo fmt -- --check
          cargo clippy -- -D warnings

      - name: üî® Build release binary
        run: |
          cargo build --release
          echo "‚úÖ Build completed successfully"

      - name: ‚ñ∂Ô∏è Run KS Forward processor
        id: run_processor
        run: |
          echo "Starting KS Forward processing at $(date)"
          cargo run --release
          echo "‚úÖ Processing completed at $(date)"

      - name: üìä Upload logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: failure-logs-${{ github.run_number }}
          path: |
            transcript_cache/
          retention-days: 7

      - name: ‚úÖ Success notification
        if: success()
        run: |
          echo "üéâ KS Forward processing completed successfully!"
          echo "Run ID: ${{ github.run_id }}"
          echo "Run Number: ${{ github.run_number }}"

      - name: ‚ùå Failure notification
        if: failure()
        run: |
          echo "‚ùå KS Forward processing failed!"
          echo "Run ID: ${{ github.run_id }}"
          echo "Please check the logs for details"
          exit 1
