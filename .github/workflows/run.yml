name: Scheduled run
on:
  schedule:
    - cron: "0 4 * * 1-5"
  workflow_dispatch:
jobs:
  run:
    runs-on: ubuntu-latest
    env:
      TZ: Asia/Bangkok
    steps:
      - uses: actions/checkout@v4
      - name: Create .env
        run: |
          cat <<'EOF' > .env
          API_URL=${{ secrets.API_URL }}
          TOKEN=${{ secrets.TOKEN }}
          YOUTUBE_API_KEY=${{ secrets.YOUTUBE_API_KEY }}
          SUPABASE_API_KEY=${{ secrets.SUPABASE_API_KEY }}
          KSFORWORD_CHANNEL_ID=${{ secrets.KSFORWORD_CHANNEL_ID }}
          USE_MOCK_DATA=${{ secrets.USE_MOCK_DATA }}
          MY_AI_API_URL=${{ secrets.MY_AI_API_URL }}
          MY_AI_API_KEY=${{ secrets.MY_AI_API_KEY }}
          DISCORD_KS_BOT_TOKEN=${{ secrets.DISCORD_KS_BOT_TOKEN }}
          EOF
      - name: Verify .env file
        run: |
          echo "=== .env file created ==="
          echo "Checking if MY_AI_API_KEY is set..."
          if grep -q "MY_AI_API_KEY=" .env && [ -n "${{ secrets.MY_AI_API_KEY }}" ]; then
            echo "✓ MY_AI_API_KEY is set (length: $(echo "${{ secrets.MY_AI_API_KEY }}" | wc -c) chars)"
          else
            echo "✗ MY_AI_API_KEY is NOT set or is empty!"
            exit 1
          fi
          echo "Checking all required variables..."
          grep -E "^(API_URL|TOKEN|YOUTUBE_API_KEY|SUPABASE_API_KEY|KSFORWORD_CHANNEL_ID|MY_AI_API_URL|MY_AI_API_KEY|DISCORD_KS_BOT_TOKEN)=" .env | sed 's/=.*/=***/'
      - name: Install Rust toolchain
        uses: actions-rs/toolchain@v1
        with:
          profile: minimal
          toolchain: stable
          override: true
      - name: Build
        run: cargo build --release
      - name: Run
        run: cargo run --release